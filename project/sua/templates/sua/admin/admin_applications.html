<!doctype html>
<html lang="en">
{% load static %}
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{% static 'sua/css/bootstrap.min.css' %}">
    <!-- bootstrap-table CSS -->
    <link rel="stylesheet" href="{% static 'sua/css/bootstrap-table.min.css' %}">

    <!-- My CSS -->
    <link rel="stylesheet" type="text/css" href="{% static 'sua/css/app.css' %}">
    <title>公益时平台</title>
</head>

<body style="background-color: #EEEEEE">
    <nav class="navbar fixed-top navbar-expand-lg navbar-dark" style="background-color: #4d4d4d;">
        <a class="navbar-brand" href="/">
            <img src="{% static 'sua/images/logo-icon3.png' %}" width="30" height="30" class="d-inline-block align-top"
                alt=""> 数院公益时
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
              <li class="nav-item">
                  <a class="nav-link" href="/">主页 <span
                          class="sr-only">(current)</span></a>
              </li>
              <li class="nav-item">
                  <a class="nav-link" href="/students/tab">学生列表</a>
              </li>
              <li class="nav-item">
                  <a class="nav-link" href="/activities/tab">活动列表</a>
              </li>
              <li class="nav-item active">
                  <a class="nav-link" href="/applications/tab">申请列表</a>
              </li>
              <li class="nav-item">
                  <a class="nav-link" href="/appeals/tab">申诉列表</a>
              </li>
              <li class="nav-item">
                  <a class="nav-link" href="/deleteds/tab">删除记录</a>
                </li>
            </ul>
            <ul class="navbar-nav my-2 my-lg-0">
                <li class="nav-item dropdown active">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false">
                        <img src="{% static 'sua/images/plus.png' %}" width="15" height="15" class="d-inline-block"
                            alt="" style="mix-blend-mode: #fff">
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="/activities/add/">创建活动</a>
                        <a class="dropdown-item" href="/admin/AcademicYear/">更改学年度</a>
                    </div>
                </li>
                <li class="nav-item dropdown active">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false">
                        {{ nav.user.username }}
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                        <!-- <a class="dropdown-item" href="#">我的信息</a>
                        <div class="dropdown-divider"></div> -->
                        <a class="dropdown-item" href="/logout">登出</a>
                        <a class="dropdown-item" href="/admin/AdminChangeInfo/">更改联系方式</a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mt-5 pt-5">
        <div class="row">
            <div class="col-sm">
                <div class="card card-table mb-4">
                    <div class="card-body card-table-header">
                      <div class="tools">
                          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
                              aria-expanded="false">
                              <img src="{% static 'sua/images/plus2.png' %}" width="20" height="20" class="d-inline-block"
                                  alt="" style="mix-blend-mode: #fff">
                          </a>
                          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                              <a class="dropdown-item" href="/applications/merge/">合并申请活动</a>
                          </div>
                      </div>
                        <div class="my-card-header">
                            待处理的申请
                            <div class="tools">
                            </div>
                        </div>
                    </div>
                    <div class="card-body card-table-body">
                        <table id="pending-applications"
                               data-toggle="table"
                               data-classes="table table-hover table-striped"

                               data-checkbox-header="false"

                               data-search="true"
                               data-search-align="left"

                               data-show-fullscreen="true"

                               data-click-to-select="true"
                               data-maintain-selected="true"

                               data-pagination="true">
                            <thead>
                                <tr>
                                    <th data-checkbox="true" data-sortable="true"></th>
                                    <th data-sortable="true">活动名称</th>
                                    <th data-sortable="true">申请日期</th>
                                    <th data-sortable="true">申请人</th>
                                    <th data-sortable="true">举办单位</th>
                                    <th data-sortable="true">公益时数</th>
                                    <th data-sortable="true">审核结果</th>
                                    <th style="width: 10%;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for application in unreviewed_applications %}
                                <tr data-application-id="{{ application.id }}" data-initial-checked="{{ application.mark|lower }}">
                                    <td></td>
                                    <td>{{ application.sua.activity.title }}</td>
                                    <td>{{ application.created }}</td>
                                    <td>{{ application.sua.student.name }}</td>
                                    <td>{{ application.sua.activity.group }}</td>
                                    <td>{{ application.sua.suahours }}</td>
                                    <td>{% if application.is_checked %}已审核{% else %}未审核{% endif %}</td>
                                    <td>
                                        <div class="btn-group btn-hspace">
                                            <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">操作</button>
                                            <div class="dropdown-menu" role="menu" x-placement="bottom-start" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(-95px, 30px, 0px);">
                                                <a class="dropdown-item" href="{{ application.url }}">查看详情</a>
                                                {% comment %}
                                                {% if application.mark %}
                                                    <a class="dropdown-item" href="/admin/applications/{{ application.id }}/mark/">取消标记</a>
                                                {% else %}
                                                    <a class="dropdown-item" href="/admin/applications/{{ application.id }}/mark/">标记</a>
                                                {% endif %}
                                                {% endcomment %}
                                                <a class="dropdown-item" href="/applications/{{ application.id }}/delete/">删除</a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card card-table mb-4">
                    <div class="card-body card-table-header">
                        <div class="my-card-header">
                            已处理的申请
                            <div class="tools">
                            </div>
                        </div>
                    </div>
                    <div class="card-body card-table-body">
                        <div class="table-responsive">
                            <table id="approved-applications"
                                   data-toggle="table"
                                   data-classes="table table-hover table-striped"

                                   data-checkbox-header="false"

                                   data-search="true"
                                   data-search-align="left"

                                   data-show-fullscreen="true"

                                   data-click-to-select="true"
                                   data-maintain-selected="true"

                                   data-pagination="true">
                                <thead>
                                    <tr>
                                        <th data-checkbox="true" data-sortable="true"></th>
                                        <th data-sortable="true">活动名称</th>
                                        <th data-sortable="true">申请日期</th>
                                        <th data-sortable="true">申请人</th>
                                        <th data-sortable="true">举办单位</th>
                                        <th data-sortable="true">公益时数</th>
                                        <th data-sortable="true">审核结果</th>
                                        <th style="width: 10%;"></th>
                                    </tr>
                                </thead>

                                <tbody>
                                  {% for application in applications %}
                                    <tr data-application-id="{{ application.id }}" data-initial-checked="{{ application.mark|lower }}">
                                        <td ></td>
                                        <td>{{ application.sua.activity.title }}</td>
                                        <td>{{ application.created }}</td>
                                        <td>{{ application.sua.student.name }}</td>
                                        <td>{{ application.sua.activity.group }}</td>
                                        <td>{{ application.sua.suahours }}</td>
                                        <td>{% if application.is_checked %}已审核{% else %}未审核{% endif %}</td>
                                        <td>
                                            <div class="btn-group btn-hspace">
                                                <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">操作</button>
                                                <div class="dropdown-menu" role="menu" x-placement="bottom-start" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(-95px, 30px, 0px);">
                                                    <a class="dropdown-item" href="{{ application.url }}">查看详情</a>
                                                    <a class="dropdown-item" href="/applications/{{ application.id }}/delete/">删除</a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="{% static 'sua/js/jquery-3.3.1.slim.min.js' %}"></script>
    <script src="{% static 'sua/js/popper.min.js' %}"></script>
    <script src="{% static 'sua/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'sua/js/bootstrap-table.min.js' %}"></script>
    <script src="{% static 'sua/js/i18n/bootstrap-table-zh-CN.min.js' %}"></script>
    <script>
    ;(function() {
        ;"use strict"
        var applicationTables = ["#pending-applications", "#approved-applications"]

        // click event factory
        var clickEvent = function() {
            return new MouseEvent('click', {
                'view': window,
                'bubbles': true,
                'cancelable': true
            })
        }

        var lastMarkTime = Date.now();

        var markHandler = function(table, oncheck) {
            return function(e, row, elem) {
                if (Math.abs(Date.now() - lastMarkTime) < 300){
                    e.preventDefault()
                    return
                }
                markAPIurl = "/admin/applications/" + row._data["application-id"] + "/mark/"
                request = new XMLHttpRequest()
                request.onerror = function() {e.preventDefault()}
                request.onabort = function() {e.preventDefault()}
                request.open("GET", markAPIurl)
                request.send(null)
                lastMarkTime = Date.now()
            }
        }

        $(document).ready(function() {
            applicationTables.map(function(tableId) {
                //add text to the chackbox header
                $('th.bs-checkbox>div').text("标记")
                $('th.bs-checkbox>div.fht-cell').text('')
                // check all the table that is marked
                var table = $(tableId)
                $.each($(tableId + '>tbody>tr[data-initial-checked="true"]'), function(index, elem) {
                    table.bootstrapTable("check", $(this).attr("data-index"))
                })
                // simulate click to toggle sort
                // click twice to make the sort order "decrease"
                var header = $(tableId + '>thead>tr>th[data-field="0"]>div')[0]
                header.dispatchEvent(clickEvent())
                header.dispatchEvent(clickEvent())

                //addMarkHandler
                table.on('check.bs.table', markHandler(table, true))
                table.on('uncheck.bs.table', markHandler(table, false))
            })
        })
    })()
    </script>
</body>

</html>
